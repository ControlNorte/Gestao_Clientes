{% extends "base.html" %}

{% block title %}{{ titulo }} · Gestão de Clientes{% endblock %}

{% block content %}
{% with current_url=request.resolver_match.url_name %}
<main class="pt-8 pb-16 bg-gray-50 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Hero -->
    <section
      class="relative overflow-hidden rounded-3xl bg-[#311E5C] text-white shadow-xl mb-8 transition-all hover:shadow-2xl">
      <div class="absolute top-0 right-0 -mr-20 -mt-20 w-80 h-80 bg-[#FFC42E] opacity-10 blur-3xl rounded-full"></div>
      <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-72 h-72 bg-[#7c3aed] opacity-20 blur-3xl rounded-full"></div>
      <div class="relative px-8 py-10">
        <p class="text-sm uppercase tracking-widest text-white/70 mb-2">Clientes</p>
        <h1 class="text-3xl font-bold mb-3">{{ titulo }}</h1>
        <p class="text-white/80 max-w-2xl">Preencha os dados do cliente e mantenha sua base sempre atualizada.</p>
      </div>
    </section>

    <!-- Navigation Tabs -->
    <nav class="border-b border-[#C9CBCC]/60 mb-8">
      <ul class="flex flex-wrap gap-4 text-sm font-medium text-[#311E5C]/80">
        <li>
          <a href="{% url 'clientes:dashboard' %}"
            class="inline-block px-3 py-2 {% if current_url == 'dashboard' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Dashboard
          </a>
        </li>
        <li>
          <a href="{% url 'clientes:client_list' %}"
            class="inline-block px-3 py-2 {% if current_url == 'client_list' or current_url == 'client_create' or current_url == 'client_update' or current_url == 'client_delete' or current_url == 'client_transfer' or current_url == 'client_exit' or current_url == 'client_import' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Clientes
          </a>
        </li>
        <li>
          <a href="{% url 'clientes:reunioes_lista' %}"
            class="inline-block px-3 py-2 {% if current_url == 'reunioes_lista' or current_url == 'reuniao_preferencias' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Reuniões
          </a>
        </li>
        <li>
          <a href="{% url 'clientes:agendamentos' %}"
            class="inline-block px-3 py-2 {% if current_url == 'agendamentos' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Agendamentos
          </a>
        </li>
      </ul>
    </nav>

    <!-- Form Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="p-6 border-b border-gray-100">
        <h2 class="text-xl font-semibold text-gray-900">{{ titulo }}</h2>
        <p class="text-sm text-gray-500">Todos os campos principais são obrigatórios.</p>
      </div>
      <div class="p-6">
        <form method="post" class="space-y-6">
          {% csrf_token %}
          {% if form.non_field_errors %}
          <div class="rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
            {% endfor %}
          </div>
          {% endif %}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            {% if 'nome' in form.fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label>
              {{ form.nome }}
              {% for error in form.nome.errors %}
              <p class="text-sm text-red-600 mt-1">{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
            {% if 'quer_alinhamento' in form.fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Requer alinhamento?</label>
              <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5">
                {{ form.quer_alinhamento }}
                <label class="text-sm text-gray-700" for="{{ form.quer_alinhamento.id_for_label }}">Alinhamento</label>
              </div>
            </div>
            {% endif %}
            {% if 'responsavel' in form.fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
              {{ form.responsavel }}
            </div>
            {% endif %}
            {% if 'status' in form.fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              {{ form.status }}
            </div>
            {% endif %}
            {% if 'termometro' in form.fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Termômetro</label>
              {{ form.termometro }}
            </div>
            {% endif %}
            {% if 'valor' in form.fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
              {{ form.valor }}
              {% for error in form.valor.errors %}
              <p class="text-sm text-red-600 mt-1">{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
            {% if 'saida' in form.fields or 'motivo' in form.fields or 'razao' in form.fields %}
            {% if 'status' in form.fields %}
            {% with status_value=form.status.value %}
            <div id="exit-fields"
              class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5 {% if status_value != 'INATIVO' %}hidden{% endif %}">
              {% if 'saida' in form.fields %}
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data de Saída</label>
                {{ form.saida }}
                {% for error in form.saida.errors %}
                <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
              </div>
              {% endif %}
              <div class="md:col-span-2 space-y-5">
                {% if 'motivo' in form.fields %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
                  {{ form.motivo }}
                  {% for error in form.motivo.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
                {% if 'razao' in form.fields %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Razão</label>
                  {{ form.razao }}
                  {% for error in form.razao.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>
            {% endwith %}
            {% else %}
            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5">
              {% if 'saida' in form.fields %}
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data de Saída</label>
                {{ form.saida }}
                {% for error in form.saida.errors %}
                <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
              </div>
              {% endif %}
              <div class="md:col-span-2 space-y-5">
                {% if 'motivo' in form.fields %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
                  {{ form.motivo }}
                  {% for error in form.motivo.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
                {% if 'razao' in form.fields %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Razão</label>
                  {{ form.razao }}
                  {% for error in form.razao.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            {% endif %}
          </div>

          {% if 'permuta' in form.fields %}
          <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">
            {{ form.permuta }}
            <label class="text-sm text-gray-700" for="{{ form.permuta.id_for_label }}">Cliente em permuta</label>
          </div>
          {% endif %}

          <div class="flex flex-col sm:flex-row sm:justify-between gap-3 pt-4">
            <a class="inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-xl hover:bg-gray-200 transition"
              href="{% url 'clientes:client_list' %}">Cancelar</a>
            <button
              class="inline-flex items-center justify-center px-6 py-2.5 text-sm font-semibold text-white bg-[#311E5C] rounded-xl shadow-sm hover:bg-[#271547] transition"
              type="submit">
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>
{% endwith %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    {% if 'permuta' in form.fields and 'valor' in form.fields %}
    const permutaCheckbox = document.getElementById("{{ form.permuta.id_for_label }}");
    const valorInput = document.getElementById("{{ form.valor.id_for_label }}");
    if (permutaCheckbox && valorInput) {
      const toggleValor = () => {
        if (permutaCheckbox.checked) {
          valorInput.value = "0";
          valorInput.setAttribute("readonly", "readonly");
        } else {
          valorInput.removeAttribute("readonly");
        }
      };
      permutaCheckbox.addEventListener("change", toggleValor);
      toggleValor();
    }
    {% endif %}

    {% if 'status' in form.fields %}
    {% if 'saida' in form.fields or 'motivo' in form.fields or 'razao' in form.fields %}
    const statusField = document.getElementById("{{ form.status.id_for_label }}");
    const exitFields = document.getElementById("exit-fields");
    if (statusField && exitFields) {
      const toggleExitFields = () => {
        const shouldShow = statusField.value === "INATIVO";
        exitFields.classList.toggle("hidden", !shouldShow);
      };
      statusField.addEventListener("change", toggleExitFields);
      toggleExitFields();
    }
    {% endif %}
    {% endif %}
  });
</script>
{% endblock %}