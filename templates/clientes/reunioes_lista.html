{% extends "base.html" %}

{% block title %}Reuniões · Gestão de Clientes{% endblock %}

{% block content %}
{% with current_url=request.resolver_match.url_name %}
<main class="pt-8 pb-16 bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold text-[#311E5C]">Reuniões de alinhamento e fechamento</h1>
      </div>
      {% load clientes_filters %}
      {% if user.is_superuser or user|has_group:"Administrador" %}
      <div class="flex flex-wrap items-center gap-2">
        <a href="{% url 'clientes:reunioes_export' %}"
          class="inline-flex items-center gap-2 text-sm font-medium text-white bg-[#0f766e] hover:bg-[#0b5f58] px-3 py-2 rounded-lg shadow-sm hover:shadow transition">
          <ion-icon name="download-outline" class="text-base"></ion-icon>
          <span>Exportar Excel</span>
        </a>
        <a href="{% url 'clientes:responsaveis' %}"
          class="inline-flex items-center gap-2 text-sm font-medium text-[#311E5C] hover:text-[#311E5C] px-3 py-2 rounded-lg border border-[#C9CBCC] bg-white shadow-sm hover:shadow transition">
          <ion-icon name="ellipsis-vertical-sharp" class="text-base"></ion-icon>
          <span>Mais opções</span>
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Navigation Tabs -->
    <nav class="border-b border-[#C9CBCC]/60 mb-8">
      <ul class="flex flex-wrap gap-4 text-sm font-medium text-[#311E5C]/80">
        {% if user.is_superuser or user|has_group:"Administrador" %}
        <li>
          <a href="{% url 'clientes:dashboard' %}"
            class="inline-block px-3 py-2 {% if current_url == 'dashboard' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Dashboard
          </a>
        </li>
        <li>
          <a href="{% url 'clientes:client_list' %}"
            class="inline-block px-3 py-2 {% if current_url == 'client_list' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Clientes
          </a>
        </li>
        {% endif %}
        <li>
          <a href="{% url 'clientes:reunioes_lista' %}"
            class="inline-block px-3 py-2 {% if current_url == 'reunioes_lista' or current_url == 'reuniao_preferencias' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Reuniões
          </a>
        </li>
        <li>
          <a href="{% url 'clientes:agendamentos' %}"
            class="inline-block px-3 py-2 {% if current_url == 'agendamentos' %}text-[#311E5C] border-b-2 border-[#FFC42E]{% else %}hover:text-[#311E5C] hover:border-b-2 hover:border-[#FFC42E]/70 transition{% endif %}">
            Agendamentos
          </a>
        </li>
      </ul>
    </nav>
    {% endwith %}

    <div class="grid grid-cols-1 gap-8">
      <!-- Alinhamento -->
      <section class="bg-white rounded-3xl shadow-card-sm border border-[#E6E7F5] overflow-hidden">
        <div class="flex flex-wrap items-center justify-between gap-3 px-6 py-4 border-b border-[#E6E7F5] bg-gray-50">
          <div>
            <h2 class="text-lg uppercase tracking-[0.12em] font-semibold text-[#7c3aed]">Alinhamento</h2>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-100">
              <tr>
                <th class="px-6 py-3 font-semibold">Cliente</th>
                <th class="px-6 py-3 font-semibold">Responsável</th>
                <th class="px-6 py-3 font-semibold">Período</th>
                <th class="px-6 py-3 font-semibold whitespace-nowrap">Dia da semana</th>
                <th class="px-6 py-3 font-semibold">Horário</th>
                <th class="px-6 py-3 font-semibold">Local</th>
                <th class="px-6 py-3 font-semibold">Duração</th>
                <th class="px-6 py-3 font-semibold whitespace-nowrap">Dia sugerido</th>
                <th class="px-6 py-3 font-semibold">Observações</th>
                <th class="px-6 py-3 font-semibold">Atualizado</th>
                <th class="px-6 py-3 font-semibold">Ações</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for item in alinhamentos %}
              {% if item.is_placeholder %}
              <tr class="bg-amber-50">
                <td
                  class="px-6 py-1.5 font-medium text-gray-900 max-w-40 whitespace-nowrap overflow-hidden text-ellipsis">
                  <a href="{% url 'clientes:reuniao_preferencias' item.client.pk %}"
                    class="text-[#311E5C] hover:underline">
                    {{ item.client.nome }}
                  </a>
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ item.client.responsavel|default:"—" }}
                </td>
                <td colspan="8" class="px-6 py-1.5 text-amber-700 font-semibold whitespace-nowrap">
                  {{ item.message }}
                </td>
                <td class="px-6 py-1.5">
                  <a href="{% url 'clientes:reuniao_preferencias' item.client.pk %}"
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-amber-800 bg-amber-100 hover:bg-amber-200 rounded-lg transition-colors">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    Cadastre
                  </a>
                </td>
              </tr>
              {% else %}
              {% with pref=item.pref %}
              <tr class="bg-white hover:bg-gray-50 transition-colors">
                <td
                  class="px-6 py-1.5 font-medium text-gray-900 max-w-40 whitespace-nowrap overflow-hidden text-ellipsis">
                  <a href="{% url 'clientes:reuniao_preferencias' pref.client.pk %}"
                    class="text-[#311E5C] hover:underline">
                    {{ pref.client.nome }}
                  </a>
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.responsavel_nome|default:pref.client.responsavel|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {% if pref.dia_pref_inicio and pref.dia_pref_fim %}
                  {{ pref.dia_pref_inicio }} à {{ pref.dia_pref_fim }}
                  {% elif pref.dia_pref_inicio %}
                  {{ pref.dia_pref_inicio }}
                  {% else %}
                  —
                  {% endif %}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.get_dia_semana_pref_display|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.get_horario_pref_display|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.get_local_display|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {% if pref.duracao_minutos %}{{ pref.duracao_minutos }} min{% else %}—{% endif %}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {% if pref.data_sugerida %}{{ pref.data_sugerida }}{% else %}—{% endif %}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.observacoes|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.atualizado_em|date:"d/m/Y H:i" }}
                </td>
                <td class="px-6 py-1.5">
                  <a href="{% url 'clientes:reuniao_preferencias' pref.client.pk %}"
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-[#311E5C] bg-[#311E5C]/5 hover:bg-[#311E5C]/10 rounded-lg transition-colors">
                    <ion-icon name="create-outline"></ion-icon>
                    Editar
                  </a>
                </td>
              </tr>
              {% endwith %}
              {% endif %}
              {% empty %}
              <tr>
                <td colspan="11" class="px-6 py-10 text-center text-gray-500">
                  Nenhuma preferência de alinhamento cadastrada.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Fechamento -->
      <section class="bg-white rounded-3xl shadow-card-sm border border-[#E6E7F5] overflow-hidden">
        <div class="flex flex-wrap items-center justify-between gap-3 px-6 py-4 border-b border-[#E6E7F5] bg-gray-50">
          <div>
            <h2 class="text-lg uppercase tracking-[0.12em] font-semibold text-[#0f766e]">Fechamento</h2>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-100">
              <tr>
                <th class="px-6 py-3 font-semibold">Cliente</th>
                <th class="px-6 py-3 font-semibold">Consultor</th>
                <th class="px-6 py-3 font-semibold">Período</th>
                <th class="px-6 py-3 font-semibold whitespace-nowrap">Dia da semana</th>
                <th class="px-6 py-3 font-semibold">Horário</th>
                <th class="px-6 py-3 font-semibold">Local</th>
                <th class="px-6 py-3 font-semibold">Duração</th>
                <th class="px-6 py-3 font-semibold whitespace-nowrap">Dia sugerido</th>
                <th class="px-6 py-3 font-semibold">Observações</th>
                <th class="px-6 py-3 font-semibold">Atualizado</th>
                <th class="px-6 py-3 font-semibold">Ações</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for item in fechamentos %}
              {% if item.is_placeholder %}
              <tr class="bg-emerald-50">
                <td
                  class="px-6 py-1.5 font-medium text-gray-900 max-w-40 whitespace-nowrap overflow-hidden text-ellipsis">
                  <a href="{% url 'clientes:reuniao_preferencias' item.client.pk %}"
                    class="text-[#311E5C] hover:underline">
                    {{ item.client.nome }}
                  </a>
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ item.client.responsavel|default:"—" }}
                </td>
                <td colspan="8" class="px-6 py-1.5 text-emerald-700 font-semibold whitespace-nowrap">
                  {{ item.message }}
                </td>
                <td class="px-6 py-1.5 whitespace-nowrap">
                  <a href="{% url 'clientes:reuniao_preferencias' item.client.pk %}"
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-[#0f766e] bg-emerald-100 hover:bg-emerald-200 rounded-lg transition-colors">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    Cadastre
                  </a>
                </td>
              </tr>
              {% else %}
              {% with pref=item.pref %}
              <tr class="bg-white hover:bg-gray-50 transition-colors">
                <td
                  class="px-6 py-1.5 font-medium text-gray-900 max-w-40 whitespace-nowrap overflow-hidden text-ellipsis">
                  <a href="{% url 'clientes:reuniao_preferencias' pref.client.pk %}"
                    class="text-[#311E5C] hover:underline">
                    {{ pref.client.nome }}
                  </a>
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.consultor|default:pref.responsavel_nome|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {% if pref.dia_pref_inicio and pref.dia_pref_fim %}
                  {{ pref.dia_pref_inicio }} à {{ pref.dia_pref_fim }}
                  {% elif pref.dia_pref_inicio %}
                  {{ pref.dia_pref_inicio }}
                  {% else %}
                  —
                  {% endif %}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.get_dia_semana_pref_display|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.get_horario_pref_display|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.get_local_display|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {% if pref.duracao_minutos %}{{ pref.duracao_minutos }} min{% else %}—{% endif %}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {% if pref.data_sugerida %}{{ pref.data_sugerida }}{% else %}—{% endif %}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.observacoes|default:"—" }}
                </td>
                <td class="px-6 py-1.5 text-gray-700 whitespace-nowrap">
                  {{ pref.atualizado_em|date:"d/m/Y H:i" }}
                </td>
                <td class="px-6 py-1.5">
                  <a href="{% url 'clientes:reuniao_preferencias' pref.client.pk %}"
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-[#311E5C] bg-[#311E5C]/5 hover:bg-[#311E5C]/10 rounded-lg transition-colors">
                    <ion-icon name="create-outline"></ion-icon> Editar
                  </a>
                </td>
              </tr>
              {% endwith %}
              {% endif %}
              {% empty %}
              <tr>
                <td colspan="11" class="px-6 py-10 text-center text-gray-500">Nenhuma preferência de fechamento
                  cadastrada.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</main>
{% endblock %}